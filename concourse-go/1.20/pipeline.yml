---
resource_types:
- name: static
  type: docker-image
  source: { repository: ktchen14/static-resource }

resources:
  # Dockerfile source
  - name: 'concourse-go_1_20-dockerfile'
    .: (( inject meta.resources.dockerfiles ))
    source:
      paths:
        - concourse-go/1.20/Dockerfile

  # Triggers for new version of golang 1.20
  - name: golang-version
    .: (( inject meta.resources.dockerhub ))
    type: registry-image
    source:
      email: ((prune))
      repository: golang
      tag: '1.20'

  # Extra tags
  - name: additional-tags
    type: static
    source: 
      values: "v1.20-ubuntu-jammy v1.20"
  

  # Build outputs
  - name: concourse-go_latest-image
    .: (( inject meta.resources.local-registry ))
    source:
      repository: (( concat meta.image-registry.account "/concourse-go" ))
      tag: latest

  - name: concourse-go_latest-dockerhub
    .: (( inject meta.resources.dockerhub ))
    source:
      repository: (( concat meta.dockerhub.account "/concourse-go" ))
      tag: latest


jobs:
  - name: build-concourse-go_1_20
    public: true
    plan:
      - get: additional-tags

      - get: concourse-go_1_20-dockerfile
        trigger: true

      - get: golang-version
        trigger: true
        params: {skip_download: true}

      - get: concourse-image
        resource: concourse_ubuntu-jammy-image
        trigger: true
        passed: [ 'build-concourse_ubuntu-jammy' ]
        params: {skip_download: true}

      - put: 'concourse-go_latest-image'
        get_params: {save: true}
        params:
          build: 'concourse-go_1_20-dockerfile/concourse-go/1.20'
          additional_tags: additional-tags/values

      - put: concourse-go_latest-dockerhub
        params:
          load: concourse-go_latest-image
          additional_tags: additional-tags/values

